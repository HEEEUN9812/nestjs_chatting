<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App Test</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .msg { margin: 0.5rem 0; }
    .sender { font-weight: bold; margin-right: 0.5rem; }
    #chatRoomList { margin-bottom: 1rem; }
    #chatCustomer, #chatAgent {
      border: 1px solid #ddd;
      padding: 1rem;
      height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>ğŸ—¨ï¸ ìƒë‹´ ì±„íŒ…</h2>

  <!-- ìƒë‹´ì‚¬ì™€ ê³ ê° ì„ íƒ í™”ë©´ -->
  <div id="roleSelection">
    <h3>ì–´ë–¤ ì—­í• ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
    <button onclick="selectRole('customer')">ê³ ê°</button>
    <button onclick="selectRole('agent')">ìƒë‹´ì‚¬</button>
  </div>

  <!-- ê³ ê°ì˜ ì±„íŒ…ì°½ -->
  <div id="chatArea" style="display: none;">
    <div>
      <label>
        ë‹‰ë„¤ì„:
        <input id="sender" placeholder="ê³ ê° ì´ë¦„" />
      </label>
    </div>
    <div id="chatCustomer"></div>
    <input id="messageCustomer" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  </div>

  <!-- ìƒë‹´ì‚¬ ì±„íŒ…ì°½ -->
  <div id="chatAgentArea" style="display: none;">
    <div id="chatAgent"></div>
    <input id="messageAgent" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  </div>

  <!-- ìƒë‹´ì‚¬ì˜ ì±„íŒ…ë°© ëª©ë¡ -->
  <div id="agentRoomList" style="display: none;">
    <h3>ìƒë‹´í•  ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”:</h3>
    <ul id="chatRoomList"></ul>
  </div>

  <script>
    const socket = io('http://localhost:3000');
    const senderInput = document.getElementById('sender');
    const messageCustomerInput = document.getElementById('messageCustomer');
    const messageAgentInput = document.getElementById('messageAgent');
    const chatRoomList = document.getElementById('chatRoomList');
    let myRole = ''; // 'customer' or 'agent'
    let myName = '';
    let myRoomId = '';

  if (senderInput) {
    senderInput.addEventListener('input', () => {
        myName = senderInput.value;
    });
  }

  messageCustomerInput.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    if (event.shiftKey) {
      return;
    } else {
      event.preventDefault();
      sendMessage();
    }
  }
});

messageAgentInput.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    if (event.shiftKey) {
      return;
    } else {
      event.preventDefault();
      sendMessage();
    }
  }
});

    // ì—­í•  ì„ íƒ
    function selectRole(role) {
      myRole = role;
      if (role === 'customer') {
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('chatArea').style.display = 'block';
      } else if (role === 'agent') {
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('agentRoomList').style.display = 'block';
        // ìƒë‹´ì‚¬ì¼ ê²½ìš° ì—°ê²°ëœ ê³ ê° ëª©ë¡ì„ ê°€ì ¸ì˜´
        socket.emit('get_connected_rooms');
      }
    }

    function getChatBox() {
        return myRole === 'agent'
        ? document.getElementById('chatAgent')
        : document.getElementById('chatCustomer')
    }

    // ê³ ê°ì´ ë°©ì— ì…ì¥
    function joinRoom() {
      const roomId = client.id; 
      myRoomId = roomId;
      socket.emit('join_room', { roomId });
      console.log(`[Client] ë°© ${roomId}ì— ì…ì¥ ìš”ì²­`);
    }

    // ê³ ê°ì´ ë©”ì‹œì§€ ë³´ë‚´ê¸°
    function sendMessage() {
      let sender = senderInput.value;
      let message = messageCustomerInput.value;

      if (myRole === 'agent') {
        sender = 'ìƒë‹´ì‚¬';
        message = messageAgentInput.value;
      }  

      if (!sender || !message) return;

      socket.emit('send_message', {
        sender,
        message,
        roomId: myRoomId
      });

      if (myRole === 'customer') {
        messageCustomerInput.value = '';
      } else if (myRole === 'agent') {
        messageAgentInput.value = '';
  }
    }

    // ìƒë‹´ì‚¬ì—ê²Œ ì—°ê²°ëœ ë°© ëª©ë¡ ë³´ë‚´ê¸°
    socket.on('connected_rooms', (rooms) => {
      chatRoomList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
      rooms.forEach(room => {
        const li = document.createElement('li');
        li.textContent = `ë°© ID: ${room}`;
        li.onclick = () => joinRoomAsAgent(room); // ìƒë‹´ì‚¬ê°€ ë°©ì„ ì„ íƒí•  ë•Œ
        chatRoomList.appendChild(li);
      });
    });

    // ìƒë‹´ì‚¬ê°€ ë°©ì— ì…ì¥
    function joinRoomAsAgent(roomId) {
      socket.emit('join_room', { roomId });
      myRoomId = roomId;
      myName = 'ìƒë‹´ì‚¬';
      console.log(`ìƒë‹´ì‚¬ê°€ ë°© ${roomId}ì— ì…ì¥`);

      socket.emit("chat_history", {roomId});

      document.getElementById('agentRoomList').style.display = 'none';
      document.getElementById('chatAgentArea').style.display = 'block';
    }

    socket.on('receive_message', (data) => {
      const chatBox = getChatBox();
      const div = document.createElement('div');
      div.className = 'msg';

      let timeString = '';
      if (data.sendAt) {
        const date = new Date(data.sendAt);
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');

        timeString = `${year}-${month}-${day} ${hours}:${minutes}`;
      }

      if (data.isSystem) {
        div.innerHTML = `
          <div style="color: gray; font-style: italic; font-size: 0.85rem;">
          [${timeString}] ${data.message}
          </div>
        `;
      } else {
        const myMessage = data.sender === myName;
        div.style.textAlign = myMessage ? 'right' : 'left';

        div.innerHTML = `
          <span class="sender">${data.sender}</span>: ${data.message}
          <div style="font-size: 0.75rem; color: #888;">${timeString}</div>
        `;
      }
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('chat_history', (messages) => {
      const chatBox = getChatBox();
      chatBox.innerHTML = ''; // ì´ˆê¸°í™”
      messages.forEach(msg => {
        const div = document.createElement('div');
        const date = new Date(msg.sendAt || Date.now());
        const timeString = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}:${date.getSeconds().toString().padStart(2,'0')}`;
        div.className = 'msg';
        div.innerHTML = `
          <span class="sender">${msg.sender}</span>: ${msg.message}
          <div style="font-size: 0.75rem; color: #888;">${timeString}</div>
        `;
        chatBox.appendChild(div);
      });
    });
  </script>
</body>
</html>

