<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App Test</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .msg { margin: 0.5rem 0; }
    .sender { font-weight: bold; margin-right: 0.5rem; }
    #chatRoomList { margin-bottom: 1rem; }
    #chatCustomer, #chatAgent {
      border: 1px solid #ddd;
      padding: 1rem;
      height: 300px;
      overflow-y: auto;
    }
    #chatRoomList {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    #chatRoomList th, #chatRoomList td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    #chatRoomList tbody tr {
      cursor: pointer;
    }

    #chatRoomList thead tr {
      cursor: default;
    }

    #chatRoomList tbody tr:hover {
      background-color: #f5f5f5;
    }
  </style>
</head>
<body>
  <h2>ğŸ—¨ï¸ ìƒë‹´ ì±„íŒ…</h2>

  <!-- ìƒë‹´ì‚¬ì™€ ê³ ê° ì„ íƒ í™”ë©´ -->
  <div id="roleSelection">
    <h3>ì–´ë–¤ ì—­í• ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
    <button onclick="selectRole('customer')">ê³ ê°</button>
    <button onclick="selectRole('agent')">ìƒë‹´ì‚¬</button>
  </div>

  <!-- ê³ ê°ì˜ ì±„íŒ…ì°½ -->
  <div id="chatArea" style="display: none;">
    <div>
      <label>
        ë‹‰ë„¤ì„:
        <input id="sender" placeholder="ê³ ê° ì´ë¦„" />
      </label>
    </div>
    <div id="chatCustomer"></div>
    <input id="messageCustomer" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  </div>

  <!-- ìƒë‹´ì‚¬ ì±„íŒ…ì°½ -->
  <div id="chatAgentArea" style="display: none;">
    <div id="chatAgent"></div>
    <input id="messageAgent" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  </div>

  <!-- ìƒë‹´ì‚¬ì˜ ì±„íŒ…ë°© ëª©ë¡ -->
  <div id="agentRoomList" style="display: none;">
    <h3>ìƒë‹´í•  ê³ ê°ì„ ì„ íƒí•˜ì„¸ìš”:</h3>
     <table id = "chatRoomList">
      <thead>
        <tr>
          <th>ê³ ê° ID</th>
          <th>ìƒë‹´ ì‹œì‘ ì‹œê°„</th>
        </tr>
      </thead>
      <tbody></tbody>
     </table>
  </div>

  <script>
    function formatDateTime(dateInput) {
    const date = new Date(dateInput);
    if (isNaN(date.getTime())) return '';

    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }

    const socket = io('http://localhost:3000');
    const senderInput = document.getElementById('sender');
    const messageCustomerInput = document.getElementById('messageCustomer');
    const messageAgentInput = document.getElementById('messageAgent');
    const chatRoomList = document.getElementById('chatRoomList');
    let myRole = ''; // 'customer', 'agent'
    let myName = '';
    let myRoomId = '';

  if (senderInput) {
    senderInput.addEventListener('input', () => {
        myName = senderInput.value;
    });
  }

  messageCustomerInput.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    if (event.shiftKey) {
      return;
    } else {
      event.preventDefault();
      sendMessage();
    }
  }
});

messageAgentInput.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    if (event.shiftKey) {
      return;
    } else {
      event.preventDefault();
      sendMessage();
    }
  }
});

    function selectRole(role) {
      myRole = role;
      if (role === 'customer') {
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('chatArea').style.display = 'block';
      } else if (role === 'agent') {
        document.getElementById('roleSelection').style.display = 'none';
        document.getElementById('agentRoomList').style.display = 'block';
        // ì—°ê²°ëœ ê³ ê° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        socket.emit('get_connected_rooms');
      }
    }

    function getChatBox() {
        return myRole === 'agent'
        ? document.getElementById('chatAgent')
        : document.getElementById('chatCustomer')
    }

    // ë°© ì…ì¥(ê³ ê°)
    function joinRoom() {
      const roomId = client.id; 
      myRoomId = roomId;
      socket.emit('join_room', { roomId });
      console.log(`[Client] ë°© ${roomId}ì— ì…ì¥`);
    }

    // ë©”ì„¸ì§€ ì „ì†¡(ê³ ê°)
    function sendMessage() {
      let {sender , message} = myRole === 'agent' 
      ? { sender: 'ìƒë‹´ì‚¬', message: messageAgentInput.value} 
      : {sender: senderInput.value, message: messageCustomerInput.value};

      if (!sender || !message) return;

      socket.emit('send_message', {
        sender,
        message,
        roomId: myRoomId
      });

      myRole === 'agent' ? messageAgentInput.value = '' : messageCustomerInput.value = '';
    }

    // ì—°ê²°ëœ ë°© ëª©ë¡ ë‚´ë³´ë‚´ê¸°
    socket.on('connected_rooms', (rooms) => {
      const chatRoomTableBody = chatRoomList.querySelector('tbody');
      chatRoomTableBody.innerHTML = '';; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

      rooms.forEach(room => {
        const tr = document.createElement('tr');

        let formattedDate = room.createdAt ? formatDateTime(room.createdAt) : '';

        tr.innerHTML = `
          <td>${room.sender}</td>
          <td>${formattedDate}</td>
        `;

        tr.onclick = () => joinRoomAsAgent(room.roomId);
        chatRoomTableBody.appendChild(tr);
      });
    });

    // ë°© ì…ì¥(ìƒë‹´ì‚¬)
    function joinRoomAsAgent(roomId) {
      socket.emit('join_room', { roomId });
      myRoomId = roomId;
      myName = 'ìƒë‹´ì‚¬';
      console.log(`ìƒë‹´ì‚¬ê°€ ë°© ${roomId}ì— ì…ì¥`);

      socket.emit("chat_history", {roomId});

      document.getElementById('agentRoomList').style.display = 'none';
      document.getElementById('chatAgentArea').style.display = 'block';
    }

    socket.on('receive_message', (data) => {
      const chatBox = getChatBox();
      const div = document.createElement('div');
      div.className = 'msg';

      let timeString = data.sendAt ? formatDateTime(data.sendAt) : '';

      if (data.isSystem) {
        div.innerHTML = `
          <div style="color: gray; font-style: italic; font-size: 0.85rem;">
          [${timeString}] ${data.message}
          </div>
        `;
      } else {
        const myMessage = data.sender === myName;
        div.style.textAlign = myMessage ? 'right' : 'left';

        div.innerHTML = `
          <span class="sender">${data.sender}</span>: ${data.message}
          <div style="font-size: 0.75rem; color: #888;">${timeString}</div>
        `;
      }
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on('chat_history', (messages) => {
      const chatBox = getChatBox();
      chatBox.innerHTML = ''; // ì´ˆê¸°í™”
      messages.forEach(chat => {
        const div = document.createElement('div');
        let timeString = chat.sendAt ? formatDateTime(chat.sendAt) : '';
        div.className = 'msg';
        div.innerHTML = `
          <span class="sender">${chat.sender}</span>: ${chat.message}
          <div style="font-size: 0.75rem; color: #888;">${timeString}</div>
        `;
        chatBox.appendChild(div);
      });
    });
  </script>
</body>
</html>

